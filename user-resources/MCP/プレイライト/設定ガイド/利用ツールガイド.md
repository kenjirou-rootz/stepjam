# Playwright MCP 利用ツールガイド

## 🎯 このガイドについて

Playwright MCPサーバーを使った包括的なサイト検証・ブラウザ操作の実践ガイドです。  
Claude Codeが最適なツールを自動選択し、効率的な検証を実行するための指針を記載しています。

## 🧠 AI指示原則

### 最適ツール選択原則

1. **要素検証**: `locator`と`expect`の組み合わせを優先
2. **パフォーマンス**: `page.evaluate`でCore Web Vitals測定
3. **アクセシビリティ**: axe-coreとの連携で包括的監査
4. **レスポンシブ**: `page.setViewportSize`で多デバイス検証
5. **ネットワーク**: `page.route`でAPI応答検証

### 検証戦略

- **単一URL検証** → 包括的な品質チェック実行
- **複数ページ検証** → 効率的な並列処理適用
- **継続監視** → 定期実行スクリプト生成
- **比較検証** → A/Bテスト形式での差分分析

## 🚀 主要機能とコマンド例

### 1. ブラウザ操作

#### 基本ページアクセス
```javascript
// ページにアクセス
await page.goto('https://example.com');

// 要素の検証
await expect(page.locator('h1')).toBeVisible();
await expect(page.locator('title')).toHaveText('期待するタイトル');
```

#### マルチブラウザ対応
```bash
# Chromeで実行
npx @playwright/mcp@latest --browser chrome

# Firefoxで実行  
npx @playwright/mcp@latest --browser firefox

# Safariで実行
npx @playwright/mcp@latest --browser webkit
```

### 2. レスポンシブ検証

#### デバイスエミュレーション
```bash
# iPhone 15エミュレーション
npx @playwright/mcp@latest --device "iPhone 15"

# カスタムビューポート
npx @playwright/mcp@latest --viewport-size "1280,720"
```

#### 複数サイズでの検証
```javascript
const viewports = [
  { width: 1920, height: 1080 }, // Desktop
  { width: 768, height: 1024 },  // Tablet
  { width: 375, height: 667 }    // Mobile
];

for (const viewport of viewports) {
  await page.setViewportSize(viewport);
  await page.screenshot({ path: `screenshot-${viewport.width}x${viewport.height}.png` });
}
```

### 3. パフォーマンス測定

#### Core Web Vitals
```javascript
// パフォーマンス指標の測定
const metrics = await page.evaluate(() => {
  return {
    LCP: performance.getEntriesByType('largest-contentful-paint')[0]?.startTime,
    FID: performance.getEntriesByType('first-input')[0]?.processingStart,
    CLS: performance.getEntriesByType('layout-shift').reduce((cls, entry) => cls + entry.value, 0)
  };
});
```

#### ネットワーク監視
```javascript
// ネットワークリクエストの監視
page.on('request', request => {
  console.log(`Request: ${request.method()} ${request.url()}`);
});

page.on('response', response => {
  console.log(`Response: ${response.status()} ${response.url()}`);
});
```

### 4. アクセシビリティ監査

```javascript
// axe-coreを使ったアクセシビリティチェック
const accessibilityResults = await page.evaluate(async () => {
  const axe = window.axe;
  return await axe.run();
});
```

### 5. フォーム・インタラクション

```javascript
// フォーム操作
await page.fill('#email', 'test@example.com');
await page.fill('#password', 'password123');
await page.click('#submit-button');

// ファイルアップロード
await page.setInputFiles('#file-input', 'path/to/file.pdf');
```

## 📊 出力形式

### 検証結果レポート構造

```markdown
# サイト検証レポート

## 実行概要
- URL: https://example.com
- ブラウザ: Chrome 120.0
- 実行時間: 2025-08-20 15:30:00
- 所要時間: 45秒

## 機能別検証結果
- ✅ ページ表示: 合格
- ✅ レスポンシブ: 合格  
- ⚠️  パフォーマンス: 要改善（LCP: 3.2s）
- ❌ アクセシビリティ: 不合格（3件の問題）

## パフォーマンス指標
- LCP: 3.2秒
- FID: 120ms
- CLS: 0.15

## 改善提案
1. 画像最適化によるLCP改善
2. color contrastの修正
3. alt属性の追加

## 再現スクリプト
[自動生成されたPlaywrightスクリプト]
```

## 🎯 よくある検証要求と対応

### 「このサイトの表示速度を測定して」
→ Core Web Vitals + ネットワーク分析実行

### 「モバイル表示での問題を確認して」  
→ デバイスエミュレーション + レスポンシブ検証

### 「フォーム送信フローをテストして」
→ E2Eテスト + エラーハンドリング確認

### 「アクセシビリティ問題をチェックして」
→ axe-core監査 + WCAG準拠確認

### 「クロスブラウザでの表示差を確認して」
→ 複数ブラウザ並列実行 + 差分比較

## 🔧 高度な機能

### API インターセプト
```javascript
// APIレスポンスのモック
await page.route('**/api/users', route => {
  route.fulfill({
    status: 200,
    contentType: 'application/json',
    body: JSON.stringify({ users: mockUsers })
  });
});
```

### 認証フロー
```bash
# セッション状態の保存
npx @playwright/mcp@latest --storage-state "auth-state.json"
```

### トレース記録
```bash
# 詳細トレースの保存
npx @playwright/mcp@latest --save-trace
```

## 📁 ログ管理

### 実行ログの保存場所
```
stepjam/ユーザーarea/MCP/プレイライト/logs/
├── 2025-08-20_site-validation.log
├── screenshots/
├── traces/
└── reports/
```

## 🆘 トラブルシューティング

### よくある問題と解決策

| 問題 | 解決策 |
|------|--------|
| タイムアウトエラー | `--timeout`オプションで時間延長 |
| 要素が見つからない | セレクタの確認、待機処理の追加 |
| ブラウザ起動失敗 | `--no-sandbox`オプション追加 |
| パフォーマンス測定不正確 | `--headless`モードで実行 |

### デバッグモード
```bash
# ヘッドフルモードでデバッグ
npx @playwright/mcp@latest --browser chrome
```

---

**作成日**: 2025-08-20  
**作成者**: Claude Code  
**目的**: Playwright MCP環境の効果的活用ガイド  
**対応範囲**: ブラウザ操作・サイト検証・包括的品質チェック