# serena MCP 利用ガイド

最終更新: 2025年8月20日

## 目次
1. [serena MCPとは](#serena-mcpとは)
2. [Claude Code接続ガイド](#claude-code接続ガイド)
3. [使用可能ツール一覧](#使用可能ツール一覧)
4. [別デバイススタートアップガイド](#別デバイススタートアップガイド)
5. [ユーザー利用ガイド](#ユーザー利用ガイド)
6. [トラブルシューティング](#トラブルシューティング)

---

## serena MCPとは

serena MCPは、Language Server Protocol (LSP) を活用した高度なコード解析・編集ツールです。通常のテキスト検索とは異なり、コードの意味的な構造を理解して操作できます。

### 主な特徴
- **シンボルレベルの操作** - 関数、クラス、変数を意味的に理解
- **リファクタリング支援** - 参照箇所の自動検出と一括更新
- **大規模プロジェクト対応** - 効率的なインデックスとメモリ管理
- **多言語サポート** - PHP、Python、JavaScript、TypeScript等

---

## Claude Code接続ガイド

### 前提条件
- Claude Code v1.0.52以降
- uvx または pipx インストール済み
- Git環境

### 接続手順

#### 1. MCPサーバーの追加
プロジェクトディレクトリで以下を実行：

```bash
# uvx使用（推奨）
claude mcp add serena -- uvx --from git+https://github.com/oraios/serena \
  serena start-mcp-server --context ide-assistant --project "$(pwd)"

# pipx使用（uvxが無い場合）
claude mcp add serena -- pipx run --spec git+https://github.com/oraios/serena \
  serena start-mcp-server --context ide-assistant --project "$(pwd)"
```

#### 2. 接続確認
```bash
claude mcp list
```
serenaが「Connected」と表示されればOK

#### 3. 初回設定（onboarding）
Claude Codeで以下を実行：
```
/mcp__serena__check_onboarding_performed
```
未実施の場合は：
```
/mcp__serena__onboarding
```

---

## 使用可能ツール一覧

### 🔍 検索・解析ツール

| ツール名 | 説明 | 使用例 |
|---------|------|--------|
| `find_symbol` | シンボル名で関数・クラスを検索 | 関数定義を探す |
| `find_referencing_symbols` | シンボルの使用箇所を検索 | リファクタリング前の影響調査 |
| `get_symbols_overview` | ファイル内のシンボル一覧取得 | ファイル構造の把握 |
| `search_for_pattern` | 正規表現でパターン検索 | 特定の記述パターンを探す |

### ✏️ 編集ツール

| ツール名 | 説明 | 使用例 |
|---------|------|--------|
| `replace_symbol_body` | シンボル全体を置換 | 関数の実装変更 |
| `insert_before_symbol` | シンボル前に挿入 | import文の追加 |
| `insert_after_symbol` | シンボル後に挿入 | 新メソッドの追加 |

### 📁 ファイル操作ツール

| ツール名 | 説明 | 使用例 |
|---------|------|--------|
| `list_dir` | ディレクトリ内容一覧 | プロジェクト構造確認 |
| `find_file` | ファイル名パターンで検索 | 設定ファイルを探す |
| `read_file` | ファイル内容読み取り | 詳細確認 |

### 💾 メモリ管理ツール

| ツール名 | 説明 | 使用例 |
|---------|------|--------|
| `write_memory` | プロジェクト情報を保存 | コーディング規約の記録 |
| `read_memory` | 保存情報を読み取り | 過去の分析結果参照 |
| `list_memories` | メモリ一覧表示 | 保存済み情報の確認 |

---

## 別デバイススタートアップガイド

### 必要な準備

#### 1. 環境構築
```bash
# Python環境確認
python3 --version  # 3.8以上

# uvxインストール（推奨）
curl -LsSf https://github.com/astral-sh/uv/releases/download/latest/uv-installer.sh | sh

# または pipxインストール
python3 -m pip install --user pipx
python3 -m pipx ensurepath
```

#### 2. プロジェクト設定ファイル
`.serena/project.yml`を作成：

```yaml
project_name: "your-project-name"
language: php  # または python, typescript等
read_only: false
ignore_all_files_in_gitignore: true
ignored_paths:
  - ".git/**"
  - "**/node_modules/**"
  - "**/vendor/**"
  - "**/dist/**"
  - "**/.cache/**"
excluded_tools: []
initial_prompt: ""
```

#### 3. Claude Code設定
1. Claude Codeをインストール
2. プロジェクトディレクトリで`claude mcp add`実行（上記参照）
3. `.gitignore`に`.serena/`を追加

### チェックリスト
- [ ] Python 3.8以上インストール
- [ ] uvx または pipx インストール
- [ ] .serena/project.yml作成
- [ ] ignored_paths設定（大容量ディレクトリ除外）
- [ ] Claude Codeでserena追加
- [ ] onboarding実行

---

## ユーザー利用ガイド

### 🎯 使用シーン1: 関数のリファクタリング

**課題**: `get_user_data()`関数を`fetch_user_profile()`に名前変更したい

**serenaでの解決**:
```plaintext
1. 関数の影響範囲を調査
   → find_referencing_symbols で使用箇所を特定
   
2. 関数名を一括変更
   → replace_symbol_body で関数定義を更新
   → 各参照箇所を search_for_pattern + 編集で更新
```

**メリット**: 
- 見落としなく全箇所を更新
- 影響範囲が事前に明確
- IDEのリファクタリング機能相当を実現

### 🎯 使用シーン2: コードベース理解

**課題**: 新規参画プロジェクトの構造を把握したい

**serenaでの解決**:
```plaintext
1. プロジェクト概要の取得
   → list_dir で全体構造確認
   → get_symbols_overview で主要ファイルの構成確認
   
2. キー機能の理解
   → find_symbol で main/init 関数を検索
   → find_referencing_symbols で処理フローを追跡
```

**メリット**:
- 効率的な俯瞰視点の獲得
- 重要な処理の素早い特定
- ドキュメント不足を補完

### 🎯 使用シーン3: デバッグ支援

**課題**: エラーが発生する関数の原因調査

**serenaでの解決**:
```plaintext
1. エラー関数の詳細確認
   → find_symbol で関数本体を表示
   
2. 呼び出し元の調査
   → find_referencing_symbols で呼び出し箇所確認
   → 各呼び出しのコンテキストを確認
   
3. 関連処理の確認
   → search_for_pattern で類似パターンを検索
```

**メリット**:
- コールスタックの可視化
- 関連コードの横断的調査
- 問題の根本原因特定

### 🎯 使用シーン4: コード規約の徹底

**課題**: プロジェクト全体でコーディング規約を統一したい

**serenaでの解決**:
```plaintext
1. 規約をメモリに保存
   → write_memory で規約文書化
   
2. 違反パターンの検出
   → search_for_pattern で非準拠コード検索
   
3. 一括修正
   → replace_symbol_body で標準形に更新
```

**メリット**:
- 規約の永続的な記録
- 機械的なチェック可能
- 大規模な一括更新

---

## トラブルシューティング

### よくある問題と解決策

#### Q: serenaが接続されない
A: 以下を確認：
- Claude Code バージョン（1.0.52以上）
- プロジェクトパスに空白が含まれる場合は引用符で囲む
- `claude mcp list`で状態確認

#### Q: find_symbolが動作しない
A: Language Serverの問題の可能性：
- `.serena/project.yml`の`language`設定確認
- 対象ファイルが除外パスに含まれていないか確認
- PHPの場合、適切なPHP実行環境があるか確認

#### Q: インデックスがタイムアウトする
A: 大規模プロジェクトの場合：
- `ignored_paths`に不要なディレクトリを追加
- `--quick`オプションで軽量インデックス実行
- 部分的なインデックス化を検討

#### Q: メモリが見つからない
A: `.serena/memories/`ディレクトリ確認：
- `list_memories`で一覧確認
- プロジェクトパスが正しいか確認
- onboardingが完了しているか確認

### サポート情報
- [serena公式リポジトリ](https://github.com/oraios/serena)
- [MCP仕様書](https://modelcontextprotocol.io/)
- [Claude Codeドキュメント](https://docs.anthropic.com/en/docs/claude-code)

---

## 付録: プロジェクト別推奨設定

### WordPress プロジェクト
```yaml
language: php
ignored_paths:
  - "wp-admin/**"
  - "wp-includes/**"
  - "**/uploads/**"
```

### Node.js プロジェクト
```yaml
language: typescript
ignored_paths:
  - "node_modules/**"
  - "dist/**"
  - ".next/**"
```

### Python プロジェクト
```yaml
language: python
ignored_paths:
  - "venv/**"
  - "__pycache__/**"
  - "*.pyc"
```